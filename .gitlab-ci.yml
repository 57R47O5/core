stages:
  - migrate

liquibase_migrate:
  stage: migrate
  image: liquibase/liquibase:5.0

  services:
    - name: postgres:16
      alias: postgres

  variables:
    POSTGRES_HOST: postgres
    POSTGRES_PORT: 5432

    LIQUIBASE_CLASSPATH: "$CI_PROJECT_DIR/drivers/postgresql.jar"

  before_script:
    - mkdir -p "$CI_PROJECT_DIR/drivers"
    - curl -L -o "$CI_PROJECT_DIR/drivers/postgresql.jar" https://jdbc.postgresql.org/download/postgresql-42.7.8.jar

    # ‚è≥ Esperar a Postgres
    - |
      echo "Waiting for Postgres..."
      until pg_isready -h "$POSTGRES_HOST" -p "$POSTGRES_PORT"; do
        sleep 1
      done

  script:
    - liquibase --version
    - liquibase --defaultsFile=docker/liquibase/liquibase.properties update
