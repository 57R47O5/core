stages:
  - migrate

liquibase_migrate:
  stage: migrate
  image: liquibase/liquibase:5.0

  services:
    - name: postgres:16
      alias: postgres

  variables:
    LIQUIBASE_CLASSPATH: "$CI_PROJECT_DIR/drivers/postgresql.jar"

  before_script:
    - mkdir -p "$CI_PROJECT_DIR/drivers"
    - curl -L -o "$CI_PROJECT_DIR/drivers/postgresql.jar https://jdbc.postgresql.org/download/postgresql-42.7.8.jar"

    - |
      echo "Waiting for Postgres..."
      until nc -z postgres 5432; do
        sleep 1
      done

  script:
    - liquibase --version
    - liquibase --defaultsFile=docker/liquibase/liquibase.properties update
